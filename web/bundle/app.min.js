"use strict";const LIFF_PROFILE="liff-profile",UDH_PROFILE="udh-profile";var config={redirectUri:"https://www.udhconnect.info",liffId:"1654023325-EkWmY9PA",ChannelAccessToken:"FWZ3P4fRrEXOmhyQtiQFp+TXeSSrkQwGdt3zvp1TezV9gYOruopsbo4YDBjoIKSoWzd/Yx/Ow/8xT0Elwvv6N+akUpPXtdMOdi5NN+t8BMHiVFWoDopJLEn0fUJSg0Rink0gBjXMSwcKIoI6FmoaQQdB04t89/1O/w1cDnyilFU=",RichMenuId:"richmenu-7351dbcc12fcf979942367a8422087b3"},udhApp={initializeLiff:async function(e){try{await liff.init({liffId:e}),this.initializeApp()}catch(e){swal.fire({icon:"error",title:"Oops...",text:_.get(e,"message","InitializeLiff Error")})}},initializeApp:function(){liff.isLoggedIn()?this.setProflie():liff.login({redirectUri:config.redirectUri})},setProflie:async function(){try{this.startLoading();var e=await liff.getProfile();window.localStorage.setItem(LIFF_PROFILE,JSON.stringify(e)),$("#user-picture").attr("src",e.pictureUrl);var t=await axios.get("/app/appoint/profile?userId="+e.userId),i=RegExp("/","g").test(window.location.pathname)||RegExp("/app/register/*","g").test(window.location.pathname);t.data?window.localStorage.setItem(UDH_PROFILE,JSON.stringify(t.data)):(window.localStorage.getItem(UDH_PROFILE)||i)&&(t.data||i)||(window.location.href="/"),this.stopLoading()}catch(e){this.stopLoading(),swal.fire({icon:"error",title:"Oops...",text:_.get(e,"message",e)})}},getProfileStorage:function(){return window.localStorage.getItem(LIFF_PROFILE)?JSON.parse(window.localStorage.getItem(LIFF_PROFILE)):null},isRegister:function(){return null!==window.localStorage.getItem(UDH_PROFILE)},logout:function(){liff.logout(),window.localStorage.removeItem(LIFF_PROFILE),window.localStorage.removeItem(UDH_PROFILE),setTimeout(function(){window.location.href="/"},1e3)},isLoggedIn:function(){return liff.isLoggedIn()},sendMessages:async function(e){try{await liff.sendMessages(e)}catch(e){swal.fire({title:"เกิดข้อผิดพลาดในการส่งข้อความไลน์",text:e,icon:"error",confirmButtonText:"ตกลง",allowOutsideClick:!1})}},closeWindow:function(){liff.closeWindow()},LinkRichMenu:function(){var e=this.getProfileStorage(),t=e.userId;$.ajax({method:"POST",url:`https://api.line.me/v2/bot/user/${t}/richmenu/${config.RichMenuId}`,dataType:"JSON",beforeSend:function(e){e.setRequestHeader("Authorization","Bearer "+config.ChannelAccessToken)},error:function(e,t,i){swal.fire({title:"เกิดข้อผิดพลาดในการผูกริชเมนู",text:i,icon:"error",confirmButtonText:"ตกลง",allowOutsideClick:!1})}})},startLoading:function(e="body"){$(e).waitMe({effect:"roundBounce",color:"#ff518a"})},stopLoading:function(e="body"){$(e).waitMe("hide")},getFormData:function(e){for(var t=e.serializeArray(),i={},o=0;o<t.length;o++)i[t[o].name]=t[o].value;return i},initFormNewUser:function(){var e=this,t="#form-signup",i=$(t);$("#reset-form").on("click",function(){i.trigger("reset")}),i.on("beforeSubmit",function(){e.startLoading(t);var o=e.getFormData(i),n=e.getProfileStorage();return $.ajax({url:i.attr("action"),type:i.attr("method"),data:Object.assign(o,n),dataType:"JSON",success:function(o){o.success?(e.setProflie(),liff.isInClient()&&e.sendMessages(o.FlexMessage),swal.fire({title:o.message,text:"",icon:"success",showCancelButton:!1,confirmButtonText:"ตกลง",cancelButtonText:"ยกเลิก"}).then(t=>{t.value&&e.closeWindow()})):Object.keys(o.validate).map(e=>{$(i).yiiActiveForm("updateAttribute",e,o.validate[e])}),e.stopLoading(t)},error:function(i){e.stopLoading(t),swal.fire({title:"",text:i.responseJSON?i.responseJSON.message:"Error",icon:"error",confirmButtonText:"ตกลง"})}}),!1})},initFormOldUser:function(){var e=this,t="#form-search",i=$(t),o=yii.getQueryParams(window.location.search);$("#input-filter").val(o.q),$(".form-content, #btn-submit").hide(),$("#btn-search").on("click",function(){e.searchPatient()}),e.searchPatient(),i.on("beforeSubmit",function(){e.startLoading(t);var o=e.getFormData(i),n=e.getProfileStorage();return $.ajax({url:"/app/register/create-new-user?user=old",type:i.attr("method"),data:Object.assign(o,n),dataType:"JSON",success:function(o){o.success?(e.clearFormOlduser(),liff.isInClient()&&e.sendMessages(o.FlexMessage),swal.fire({title:o.message,text:"",icon:"success",showCancelButton:!1,confirmButtonText:"ตกลง",cancelButtonText:"ยกเลิก"}).then(t=>{t.value&&e.closeWindow()})):Object.keys(o.validate).map(e=>{$(i).yiiActiveForm("updateAttribute",e,o.validate[e])}),e.stopLoading(t)},error:function(i){e.stopLoading(t),swal.fire({title:"",text:i.responseJSON?i.responseJSON.message:"Error",icon:"error",confirmButtonText:"ตกลง"})}}),!1})},clearFormOlduser:function(){$("#form-search").trigger("reset"),$(".form-content,#btn-submit").hide(),$("#first_name").val(""),$("#last_name").val(""),$("#cid").val(""),$("#tel").val(""),$("#year").val(""),$("#mounh").val(""),$("#day").val(""),$("#btn-search,#filter").show()},searchPatient:function(){var e=this,t="#form-search",i=$(t),o=yii.getQueryParams(window.location.search);if(!$("#input-filter").val())return!1;var n=i.serialize();e.startLoading(t),$.ajax({url:"/app/register/patient?q="+o.q,type:i.attr("method"),data:n,dataType:"JSON",success:function(i){if(e.stopLoading(t),i){if($("#hn").val(i.hn||""),$("#first_name").val(i.firstName||""),$("#last_name").val(i.lastName||""),i.CardID&&$("#cid").val(String(i.CardID).replace(/[^0-9]/g,"")),i.phone&&$("#tel").val(String(i.phone).replace(/[^0-9]/g,"")),i.bday){var o=moment(i.bday).format("YYYY"),n=moment(i.bday).format("MM"),a=moment(i.bday).format("DD");$("#year").val(o).change(),$("#month").val(n).change(),$("#day").val(a).change()}$(".form-content,#btn-submit").show(),$("#btn-search,#filter").hide()}else $(".form-content").hide(),swal.fire({title:"Oops!",text:"ไม่พบข้อมูล",icon:"warning",confirmButtonText:"ตกลง"})},error:function(i,o,n){$(".form-content").hide(),e.stopLoading(t),swal.fire({title:"Error!",text:n,icon:"error",confirmButtonText:"ตกลง"})}})}};window.udhApp=udhApp,$(window).on("load",function(e){udhApp.initializeLiff(config.liffId)});